<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Tesoro Perdido de las Capitulaciones - Escape Room Educativo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Pantalla de inicio */
        #inicio-screen {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        .logo-capitulin {
            width: 150px;
            height: 150px;
            margin: 0 auto 30px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .story-box {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            line-height: 1.8;
        }

        .level-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .level-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .level-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .start-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* HUD del juego */
        .game-hud {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #e74c3c;
        }

        .progress-bar {
            flex: 1;
            min-width: 200px;
        }

        .progress-track {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .hints-counter {
            font-size: 1.2em;
            color: #f39c12;
            font-weight: bold;
        }

        /* Sala del juego */
        .room {
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            min-height: 500px;
            position: relative;
        }

        .room-title {
            text-align: center;
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .room-subtitle {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .puzzle-container {
            margin: 30px 0;
        }

        /* Biblioteca */
        .books-shelf {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .book {
            height: 200px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .book:hover {
            transform: translateY(-10px) scale(1.05);
        }

        .book-red { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .book-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .book-green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .book-purple { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .book-orange { background: linear-gradient(135deg, #ff9a56 0%, #ffcc70 100%); }

        .text-fragment {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: move;
            transition: all 0.3s;
            font-size: 1.1em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .text-fragment:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .text-fragment.placed {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .drop-zone {
            background: #f8f9fa;
            border: 3px dashed #adb5bd;
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            background: #e7f3ff;
            border-color: #4facfe;
        }

        .drop-zone.filled {
            background: #d4edda;
            border-color: #28a745;
        }

        /* Laboratorio */
        .lab-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .math-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .math-card:hover {
            transform: translateY(-5px);
        }

        .math-problem {
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .math-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            text-align: center;
            margin-top: 10px;
        }

        .check-btn {
            background: #38ef7d;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .check-btn:hover {
            background: #11998e;
        }

        /* Gimnasio */
        .tangram-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .pattern-item {
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .pattern-item:hover {
            transform: scale(1.1);
        }

        /* Sala de Ciencias */
        .science-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .science-card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .science-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .science-card.selected {
            border-color: #4facfe;
            background: #e7f3ff;
        }

        .science-card.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .science-card.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        /* Sala del Tesoro */
        .treasure-room {
            text-align: center;
        }

        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }

        .code-digit {
            width: 80px;
            height: 100px;
            font-size: 3em;
            text-align: center;
            border: 3px solid #667eea;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .treasure-chest {
            width: 200px;
            height: 200px;
            margin: 40px auto;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Botones */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal de pista */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-capitulin {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal p {
            font-size: 1.2em;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
        }

        .close-modal {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Certificado */
        .certificate {
            background: white;
            padding: 40px;
            border: 10px solid #FFD700;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .certificate h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .certificate p {
            font-size: 1.3em;
            line-height: 1.8;
            margin: 15px 0;
        }

        .certificate-name {
            color: #f5576c;
            font-weight: bold;
            font-size: 1.5em;
        }

        /* Efectos de √©xito */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em;
            z-index: 999;
            animation: celebrate 1s ease-out;
            pointer-events: none;
        }

        @keyframes celebrate {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .room-title { font-size: 1.8em; }
            .pattern-grid { grid-template-columns: repeat(3, 1fr); }
            .code-digit { width: 60px; height: 80px; font-size: 2em; }
            .game-hud { flex-direction: column; }
        }

        .hidden {
            display: none;
        }

        /* Capitulin animado */
        .capitulin-helper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            animation: float 3s ease-in-out infinite;
            z-index: 100;
        }

        .feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de inicio -->
        <div id="inicio-screen">
            <div class="logo-capitulin">üéì</div>
            <h1>El Tesoro Perdido de las Capitulaciones</h1>
            
            <div class="story-box">
                <p><strong>¬°Hola, aventurero!</strong></p>
                <p>Soy Capitul√≠n, la mascota del CEIP Capitulaciones. He encontrado un mapa antiguo que muestra la ubicaci√≥n de un tesoro escondido en nuestro cole.</p>
                <p>Pero hay un problema... el tesoro est√° protegido por enigmas en 5 salas diferentes. Necesito tu ayuda para resolver todos los acertijos antes de que se acabe el tiempo.</p>
                <p><strong>¬øTe atreves a ayudarme? üó∫Ô∏èüíé</strong></p>
            </div>

            <h2 style="color: white; margin: 30px 0;">Selecciona tu nivel:</h2>
            <div class="level-selector">
                <button class="level-btn" onclick="selectLevel(1)">
                    1¬∫ - 2¬∫ Primaria<br>
                    <small>‚≠ê Nivel Principiante</small>
                </button>
                <button class="level-btn" onclick="selectLevel(2)">
                    3¬∫ - 4¬∫ Primaria<br>
                    <small>‚≠ê‚≠ê Nivel Intermedio</small>
                </button>
                <button class="level-btn" onclick="selectLevel(3)">
                    5¬∫ - 6¬∫ Primaria<br>
                    <small>‚≠ê‚≠ê‚≠ê Nivel Avanzado</small>
                </button>
            </div>

            <button class="start-btn" id="start-game-btn" onclick="startGame()" disabled>
                üöÄ ¬°Comenzar Aventura!
            </button>
        </div>

        <!-- Pantalla del juego -->
        <div id="game-screen" class="hidden">
            <!-- HUD -->
            <div class="game-hud">
                <div class="timer">‚è±Ô∏è <span id="timer">60:00</span></div>
                <div class="progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="progress" style="width: 0%">
                            <span id="progress-text">0/5 Salas</span>
                        </div>
                    </div>
                </div>
                <div class="hints-counter">üí° Pistas: <span id="hints-left">3</span></div>
            </div>

            <!-- Salas -->
            <div id="room-container"></div>

            <!-- Bot√≥n de Capitul√≠n -->
            <div class="capitulin-helper" onclick="showCapitulinHelp()" title="¬øNecesitas ayuda?">
                üéì
            </div>
        </div>

        <!-- Pantalla final -->
        <div id="final-screen" class="hidden">
            <div class="certificate">
                <div style="font-size: 5em;">üèÜ</div>
                <h2>¬°CERTIFICADO DE EXPLORADOR!</h2>
                <p>Por la presente se certifica que</p>
                <p class="certificate-name" id="explorer-name">Explorador Valiente</p>
                <p>ha completado con √©xito</p>
                <p><strong>El Tesoro Perdido de las Capitulaciones</strong></p>
                <p>Tiempo: <span id="final-time">--:--</span></p>
                <p>Pistas usadas: <span id="final-hints">0</span></p>
                <p style="margin-top: 30px; font-size: 3em;">üéì</p>
                <p><em>Capitul√≠n - CEIP Capitulaciones</em></p>
                <button class="btn btn-primary" onclick="location.reload()">üîÑ Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <!-- Modal de pista -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <div class="modal-capitulin">üéì</div>
            <h2>Pista de Capitul√≠n</h2>
            <p id="hint-text"></p>
            <button class="close-modal" onclick="closeHintModal()">Entendido</button>
        </div>
    </div>

    <!-- Modal de √©xito de sala -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-capitulin">üéâ</div>
            <h2>¬°Sala Completada!</h2>
            <p id="success-text"></p>
            <p><strong>C√≥digo obtenido: <span id="code-found" style="color: #f5576c; font-size: 2em;"></span></strong></p>
            <button class="close-modal" onclick="nextRoom()">Siguiente Sala ‚û°Ô∏è</button>
        </div>
    </div>

    <script>
        // Estado del juego
        const gameState = {
            level: 0,
            currentRoom: 0,
            timeRemaining: 3600, // 60 minutos en segundos
            hintsLeft: 3,
            codes: [],
            timerInterval: null,
            roomsCompleted: 0
        };

        // Contenido por niveles
        const levelContent = {
            1: { // 1¬∫-2¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "Hab√≠a una vez",
                        "un peque√±o drag√≥n",
                        "que viv√≠a en el cole",
                        "y le gustaba leer",
                        "muchos cuentos divertidos"
                    ],
                    palabra: "LEER"
                },
                laboratorio: [
                    { problem: "5 + 3", answer: 8 },
                    { problem: "10 - 4", answer: 6 },
                    { problem: "2 √ó 3", answer: 6 },
                    { problem: "8 √∑ 2", answer: 4 }
                ],
                gimnasio: {
                    sequence: ["üî¥", "üîµ", "üî¥", "üîµ", "‚ùì"],
                    answer: "üî¥"
                },
                ciencias: [
                    { question: "¬øQu√© necesitan las plantas?", answers: ["Agua", "Luz", "Tierra"], correct: [0, 1, 2] },
                    { question: "Animal que vuela:", answers: ["P√°jaro", "Perro", "Pez"], correct: [0] }
                ]
            },
            2: { // 3¬∫-4¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "En el a√±o 1492",
                        "Crist√≥bal Col√≥n",
                        "firm√≥ las Capitulaciones",
                        "en Santa Fe, Granada",
                        "para descubrir nuevas tierras"
                    ],
                    palabra: "HISTORIA"
                },
                laboratorio: [
                    { problem: "23 + 45", answer: 68 },
                    { problem: "89 - 34", answer: 55 },
                    { problem: "7 √ó 8", answer: 56 },
                    { problem: "48 √∑ 6", answer: 8 }
                ],
                gimnasio: {
                    sequence: ["‚¨õ", "‚¨ú", "‚¨õ", "‚¨ú", "‚¨õ", "‚ùì"],
                    answer: "‚¨ú"
                },
                ciencias: [
                    { question: "Fases del agua:", answers: ["S√≥lido", "L√≠quido", "Gas"], correct: [0, 1, 2] },
                    { question: "Planeta m√°s cercano al Sol:", answers: ["Mercurio", "Venus", "Tierra"], correct: [0] }
                ]
            },
            3: { // 5¬∫-6¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "Las Capitulaciones de Santa Fe fueron",
                        "un acuerdo hist√≥rico firmado",
                        "entre los Reyes Cat√≥licos",
                        "y Crist√≥bal Col√≥n en 1492",
                        "que permiti√≥ el descubrimiento de Am√©rica"
                    ],
                    palabra: "AM√âRICA"
                },
                laboratorio: [
                    { problem: "125 + 378", answer: 503 },
                    { problem: "456 - 189", answer: 267 },
                    { problem: "23 √ó 12", answer: 276 },
                    { problem: "144 √∑ 12", answer: 12 }
                ],
                gimnasio: {
                    sequence: ["2", "4", "8", "16", "‚ùì"],
                    answer: "32"
                },
                ciencias: [
                    { question: "Tipos de energ√≠a:", answers: ["Solar", "E√≥lica", "Nuclear"], correct: [0, 1, 2] },
                    { question: "√ìrgano que bombea sangre:", answers: ["Coraz√≥n", "Pulm√≥n", "H√≠gado"], correct: [0] }
                ]
            }
        };

        const hints = [
            [
                "Lee cada fragmento con cuidado y piensa en el orden l√≥gico de la historia.",
                "¬øCu√°les son las operaciones matem√°ticas b√°sicas que conoces?",
                "Observa el patr√≥n: ¬øqu√© elemento se repite?",
                "Lee cada pregunta dos veces antes de responder.",
                "Usa los n√∫meros que has encontrado en orden."
            ],
            [
                "Los fragmentos cuentan algo importante sobre nuestro cole. ¬øEn qu√© orden tienen sentido?",
                "Recuerda las tablas de multiplicar que has aprendido.",
                "Mira la secuencia completa: ¬øcu√°l es el patr√≥n que se repite?",
                "Algunas preguntas pueden tener m√°s de una respuesta correcta.",
                "Revisa todos los c√≥digos que has encontrado en orden."
            ],
            [
                "Este texto habla de un momento hist√≥rico muy importante. ¬øPuedes ordenarlo cronol√≥gicamente?",
                "Usa la multiplicaci√≥n y divisi√≥n para verificar tus respuestas.",
                "Esta secuencia sigue una regla matem√°tica. ¬øPuedes descubrirla?",
                "Piensa en lo que has aprendido en Ciencias Naturales y Sociales.",
                "Introduce los cuatro d√≠gitos que obtuviste de cada sala."
            ]
        ];

        function selectLevel(level) {
            gameState.level = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.style.opacity = '0.5';
            });
            event.target.style.opacity = '1';
            document.getElementById('start-game-btn').disabled = false;
        }

        function startGame() {
            if (gameState.level === 0) {
                alert('Por favor, selecciona un nivel primero');
                return;
            }

            document.getElementById('inicio-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            startTimer();
            loadRoom(0);
        }

        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimer();
                
                if (gameState.timeRemaining <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (gameState.timeRemaining <= 300) { // 5 minutos
                document.getElementById('timer').style.color = '#e74c3c';
            }
        }

        function updateProgress() {
            const progress = (gameState.roomsCompleted / 5) * 100;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `${gameState.roomsCompleted}/5 Salas`;
        }

        function loadRoom(roomIndex) {
            const container = document.getElementById('room-container');
            gameState.currentRoom = roomIndex;

            const rooms = [
                createBibliotecaRoom,
                createLaboratorioRoom,
                createGimnasioRoom,
                createCienciasRoom,
                createTesoroRoom
            ];

            container.innerHTML = '';
            rooms[roomIndex]();
        }

        function createBibliotecaRoom() {
            const content = levelContent[gameState.level].biblioteca;
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üìö La Biblioteca del Saber</h2>
                    <p class="room-subtitle">Ordena los fragmentos para descubrir la historia</p>
                    
                    <div class="puzzle-container">
                        <div class="books-shelf">
                            <div class="book book-red" onclick="showFragment(0)">
                                <span>Libro 1</span>
                            </div>
                            <div class="book book-blue" onclick="showFragment(1)">
                                <span>Libro 2</span>
                            </div>
                            <div class="book book-green" onclick="showFragment(2)">
                                <span>Libro 3</span>
                            </div>
                            <div class="book book-purple" onclick="showFragment(3)">
                                <span>Libro 4</span>
                            </div>
                            <div class="book book-orange" onclick="showFragment(4)">
                                <span>Libro 5</span>
                            </div>
                        </div>

                        <div style="margin-top: 40px;">
                            <h3>Ordena la historia arrastrando los fragmentos:</h3>
                            <div id="fragments-source" style="margin: 20px 0;">
                                ${content.fragments.map((frag, i) => 
                                    `<div class="text-fragment" draggable="true" data-index="${i}" 
                                         ondragstart="drag(event)">${frag}</div>`
                                ).join('')}
                            </div>

                            <h3>Historia ordenada:</h3>
                            ${[0,1,2,3,4].map(i => 
                                `<div class="drop-zone" data-position="${i}" 
                                     ondrop="drop(event)" ondragover="allowDrop(event)">
                                     Posici√≥n ${i + 1}
                                 </div>`
                            ).join('')}
                        </div>

                        <div id="biblioteca-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(0)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkBiblioteca()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        let draggedElement = null;
        let droppedFragments = {};

        function showFragment(index) {
            const content = levelContent[gameState.level].biblioteca;
            showTemporaryMessage(content.fragments[index]);
        }

        function drag(event) {
            draggedElement = event.target;
            event.dataTransfer.effectAllowed = 'move';
        }

        function allowDrop(event) {
            event.preventDefault();
            event.target.classList.add('drag-over');
        }

        function drop(event) {
            event.preventDefault();
            event.target.classList.remove('drag-over');
            
            if (draggedElement && event.target.classList.contains('drop-zone')) {
                const position = event.target.dataset.position;
                const fragmentIndex = draggedElement.dataset.index;
                
                // Remove previous content if any
                event.target.innerHTML = draggedElement.textContent;
                event.target.classList.add('filled');
                
                droppedFragments[position] = fragmentIndex;
                draggedElement.classList.add('placed');
                draggedElement.draggable = false;
            }
        }

        function checkBiblioteca() {
            // Check if all positions are filled
            if (Object.keys(droppedFragments).length !== 5) {
                showFeedback('biblioteca-feedback', '¬°Completa todas las posiciones!', false);
                return;
            }

            // Check if order is correct (0,1,2,3,4)
            let correct = true;
            for (let i = 0; i < 5; i++) {
                if (droppedFragments[i] != i) {
                    correct = false;
                    break;
                }
            }

            if (correct) {
                const code = Math.floor(Math.random() * 9) + 1;
                gameState.codes.push(code);
                completeRoom(code, "¬°Excelente! Has ordenado la historia correctamente.");
            } else {
                showFeedback('biblioteca-feedback', 'El orden no es correcto. Int√©ntalo de nuevo.', false);
                // Reset
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.innerHTML = 'Posici√≥n ' + (parseInt(zone.dataset.position) + 1);
                    zone.classList.remove('filled');
                });
                document.querySelectorAll('.text-fragment').forEach(frag => {
                    frag.classList.remove('placed');
                    frag.draggable = true;
                });
                droppedFragments = {};
            }
        }

        function createLaboratorioRoom() {
            const content = levelContent[gameState.level].laboratorio;
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üî¨ El Laboratorio de N√∫meros</h2>
                    <p class="room-subtitle">Resuelve los problemas matem√°ticos</p>
                    
                    <div class="puzzle-container">
                        <div class="lab-table">
                            ${content.map((prob, i) => `
                                <div class="math-card">
                                    <div class="math-problem">${prob.problem} = ?</div>
                                    <input type="number" class="math-input" id="math-${i}" 
                                           placeholder="Respuesta">
                                    <button class="check-btn" onclick="checkMathProblem(${i}, ${prob.answer})">
                                        Comprobar
                                    </button>
                                    <div id="math-feedback-${i}"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(1)">üí° Pedir Pista</button>
                    </div>
                </div>
            `;

            // Store the problems count
            window.labProblemsTotal = content.length;
            window.labProblemsSolved = 0;
        }

        function checkMathProblem(index, correctAnswer) {
            const input = document.getElementById(`math-${index}`);
            const userAnswer = parseInt(input.value);
            const feedback = document.getElementById(`math-feedback-${index}`);

            if (isNaN(userAnswer)) {
                feedback.innerHTML = '<div style="color: #721c24; margin-top: 10px;">Introduce un n√∫mero</div>';
                return;
            }

            if (userAnswer === correctAnswer) {
                feedback.innerHTML = '<div style="color: #155724; margin-top: 10px;">‚úì ¬°Correcto!</div>';
                input.disabled = true;
                input.style.background = '#d4edda';
                window.labProblemsSolved++;

                if (window.labProblemsSolved === window.labProblemsTotal) {
                    setTimeout(() => {
                        const code = Math.floor(Math.random() * 9) + 1;
                        gameState.codes.push(code);
                        completeRoom(code, "¬°Fant√°stico! Has resuelto todos los problemas matem√°ticos.");
                    }, 500);
                }
            } else {
                feedback.innerHTML = '<div style="color: #721c24; margin-top: 10px;">‚úó Int√©ntalo de nuevo</div>';
                input.value = '';
            }
        }

        function createGimnasioRoom() {
            const content = levelContent[gameState.level].gimnasio;
            const container = document.getElementById('room-container');
            
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">‚öΩ El Gimnasio de los Retos</h2>
                    <p class="room-subtitle">Completa la secuencia</p>
                    
                    <div class="puzzle-container">
                        <div class="tangram-container">
                            <h3 style="text-align: center; margin-bottom: 30px;">
                                ¬øQu√© elemento falta en la secuencia?
                            </h3>
                            
                            <div class="pattern-grid">
                                ${content.sequence.map((item, i) => 
                                    `<div class="pattern-item" style="background: ${colors[i]}">
                                        ${item}
                                    </div>`
                                ).join('')}
                            </div>

                            <h3 style="text-align: center; margin: 40px 0 20px;">Selecciona la respuesta:</h3>
                            <div class="pattern-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                                ${getPatternOptions(content.sequence[0]).map(option => 
                                    `<div class="pattern-item" style="background: #ecf0f1; cursor: pointer;" 
                                          onclick="selectPattern('${option}', '${content.answer}')">
                                        ${option}
                                    </div>`
                                ).join('')}
                            </div>

                            <div id="gimnasio-feedback"></div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(2)">üí° Pedir Pista</button>
                    </div>
                </div>
            `;
        }

        function getPatternOptions(firstElement) {
            // Generate options based on the first element type
            if (firstElement === 'üî¥') return ['üî¥', 'üîµ', 'üü¢', 'üü°'];
            if (firstElement === '‚¨õ') return ['‚¨õ', '‚¨ú', 'üü®', 'üü¶'];
            if (firstElement === '2') return ['32', '24', '16', '64'];
            return ['A', 'B', 'C', 'D'];
        }

        function selectPattern(selected, correct) {
            if (selected === correct) {
                showFeedback('gimnasio-feedback', '¬°Perfecto! Has encontrado el patr√≥n.', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Excelente razonamiento l√≥gico!");
                }, 1000);
            } else {
                showFeedback('gimnasio-feedback', 'Ese no es el elemento correcto. Piensa en el patr√≥n.', false);
            }
        }

        function createCienciasRoom() {
            const content = levelContent[gameState.level].ciencias;
            const container = document.getElementById('room-container');
            
            window.scienceAnswers = {};
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üåç La Sala de Ciencias</h2>
                    <p class="room-subtitle">Responde las preguntas cient√≠ficas</p>
                    
                    <div class="puzzle-container">
                        ${content.map((question, qIndex) => `
                            <div style="margin: 30px 0;">
                                <h3 style="text-align: center; color: #667eea; margin-bottom: 20px;">
                                    ${question.question}
                                </h3>
                                <div class="science-grid" id="science-q${qIndex}">
                                    ${question.answers.map((answer, aIndex) => `
                                        <div class="science-card" 
                                             onclick="toggleScienceAnswer(${qIndex}, ${aIndex}, ${JSON.stringify(question.correct)})">
                                            <div style="font-size: 3em; margin-bottom: 10px;">
                                                ${getScienceIcon(answer)}
                                            </div>
                                            <p style="font-weight: bold;">${answer}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}

                        <div id="ciencias-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(3)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkCiencias(${JSON.stringify(content)})">
                            ‚úì Comprobar Respuestas
                        </button>
                    </div>
                </div>
            `;
        }

        function getScienceIcon(answer) {
            const icons = {
                'Agua': 'üíß', 'Luz': '‚òÄÔ∏è', 'Tierra': 'üå±',
                'P√°jaro': 'üê¶', 'Perro': 'üêï', 'Pez': 'üêü',
                'S√≥lido': 'üßä', 'L√≠quido': 'üíß', 'Gas': 'üí®',
                'Mercurio': '‚òøÔ∏è', 'Venus': '‚ôÄÔ∏è', 'Tierra': 'üåç',
                'Solar': '‚òÄÔ∏è', 'E√≥lica': 'üí®', 'Nuclear': '‚öõÔ∏è',
                'Coraz√≥n': '‚ù§Ô∏è', 'Pulm√≥n': 'ü´Å', 'H√≠gado': 'ü´Ä'
            };
            return icons[answer] || 'üìö';
        }

        function toggleScienceAnswer(questionIndex, answerIndex, correctAnswers) {
            if (!window.scienceAnswers[questionIndex]) {
                window.scienceAnswers[questionIndex] = [];
            }

            const card = document.querySelectorAll(`#science-q${questionIndex} .science-card`)[answerIndex];
            
            if (window.scienceAnswers[questionIndex].includes(answerIndex)) {
                // Deselect
                const index = window.scienceAnswers[questionIndex].indexOf(answerIndex);
                window.scienceAnswers[questionIndex].splice(index, 1);
                card.classList.remove('selected');
            } else {
                // Select
                window.scienceAnswers[questionIndex].push(answerIndex);
                card.classList.add('selected');
            }
        }

        function checkCiencias(content) {
            let allCorrect = true;

            content.forEach((question, qIndex) => {
                const userAnswers = window.scienceAnswers[qIndex] || [];
                const correctAnswers = question.correct;

                // Check if arrays are equal (order doesn't matter)
                const isCorrect = userAnswers.length === correctAnswers.length &&
                                userAnswers.every(ans => correctAnswers.includes(ans));

                const cards = document.querySelectorAll(`#science-q${qIndex} .science-card`);
                cards.forEach((card, aIndex) => {
                    card.classList.remove('correct', 'incorrect', 'selected');
                    if (correctAnswers.includes(aIndex)) {
                        card.classList.add('correct');
                    } else if (userAnswers.includes(aIndex)) {
                        card.classList.add('incorrect');
                        allCorrect = false;
                    }
                });

                if (!isCorrect) allCorrect = false;
            });

            if (allCorrect) {
                showFeedback('ciencias-feedback', '¬°Todas las respuestas son correctas!', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Impresionante conocimiento cient√≠fico!");
                }, 1000);
            } else {
                showFeedback('ciencias-feedback', 'Algunas respuestas no son correctas. Revisa las marcadas en rojo.', false);
            }
        }

        function createTesoroRoom() {
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room treasure-room">
                    <h2 class="room-title">üíé La Sala del Tesoro</h2>
                    <p class="room-subtitle">Introduce el c√≥digo de 4 cifras que has descubierto</p>
                    
                    <div class="puzzle-container">
                        <div class="treasure-chest">üéÅ</div>

                        <p style="text-align: center; font-size: 1.3em; margin: 30px 0;">
                            Recuerda los n√∫meros que obtuviste en cada sala:
                        </p>

                        <div class="code-input-container">
                            <input type="number" class="code-digit" id="digit-0" min="0" max="9" 
                                   onkeyup="moveToNext(0)" maxlength="1">
                            <input type="number" class="code-digit" id="digit-1" min="0" max="9" 
                                   onkeyup="moveToNext(1)" maxlength="1">
                            <input type="number" class="code-digit" id="digit-2" min="0" max="9" 
                                   onkeyup="moveToNext(2)" maxlength="1">
                            <input type="number" class="code-digit" id="digit-3" min="0" max="9" 
                                   onkeyup="moveToNext(3)" maxlength="1">
                        </div>

                        <div id="tesoro-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(4)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkTreasureCode()">
                            üîì Abrir Cofre
                        </button>
                    </div>
                </div>
            `;
        }

        function moveToNext(current) {
            const input = document.getElementById(`digit-${current}`);
            if (input.value.length === 1 && current < 3) {
                document.getElementById(`digit-${current + 1}`).focus();
            }
        }

        function checkTreasureCode() {
            const enteredCode = [];
            for (let i = 0; i < 4; i++) {
                const value = document.getElementById(`digit-${i}`).value;
                if (value === '') {
                    showFeedback('tesoro-feedback', 'Completa los 4 d√≠gitos', false);
                    return;
                }
                enteredCode.push(parseInt(value));
            }

            // Check if code matches
            let correct = true;
            for (let i = 0; i < 4; i++) {
                if (enteredCode[i] !== gameState.codes[i]) {
                    correct = false;
                    break;
                }
            }

            if (correct) {
                showSuccessAnimation('üéâ');
                setTimeout(() => {
                    finishGame();
                }, 2000);
            } else {
                showFeedback('tesoro-feedback', 'C√≥digo incorrecto. Revisa los n√∫meros que obtuviste en cada sala.', false);
            }
        }

        function showFeedback(elementId, message, isCorrect) {
            const feedback = document.getElementById(elementId);
            feedback.innerHTML = `<div class="feedback ${isCorrect ? 'correct' : 'incorrect'}">${message}</div>`;
            setTimeout(() => {
                feedback.innerHTML = '';
            }, 3000);
        }

        function showTemporaryMessage(message) {
            const modal = document.getElementById('hint-modal');
            document.getElementById('hint-text').textContent = message;
            modal.classList.add('show');
        }

        function completeRoom(code, message) {
            gameState.roomsCompleted++;
            updateProgress();

            document.getElementById('success-text').textContent = message;
            document.getElementById('code-found').textContent = code;
            document.getElementById('success-modal').classList.add('show');

            showSuccessAnimation('‚≠ê');
        }

        function showSuccessAnimation(emoji) {
            const animation = document.createElement('div');
            animation.className = 'success-animation';
            animation.textContent = emoji;
            document.body.appendChild(animation);
            setTimeout(() => animation.remove(), 1000);
        }

        function nextRoom() {
            document.getElementById('success-modal').classList.remove('show');
            if (gameState.currentRoom < 4) {
                loadRoom(gameState.currentRoom + 1);
            }
        }

        function showHint(roomIndex) {
            if (gameState.hintsLeft <= 0) {
                alert('No te quedan m√°s pistas disponibles');
                return;
            }

            gameState.hintsLeft--;
            gameState.timeRemaining -= 120; // Penalizaci√≥n de 2 minutos
            document.getElementById('hints-left').textContent = gameState.hintsLeft;

            const hintText = hints[gameState.level - 1][roomIndex];
            document.getElementById('hint-text').textContent = hintText;
            document.getElementById('hint-modal').classList.add('show');
        }

        function showCapitulinHelp() {
            const messages = [
                "¬°Hola! Soy Capitul√≠n. ¬øNecesitas ayuda? Recuerda que puedes usar el bot√≥n de pistas en cada sala.",
                "¬°√Ånimo! Est√°s haciendo un gran trabajo. Lee bien cada pregunta antes de responder.",
                "No te rindas. Si algo es dif√≠cil, t√≥mate tu tiempo para pensar.",
                "¬°Vas muy bien! Cada sala que completes te acerca m√°s al tesoro.",
                "Recuerda: no hay prisa, pero el tiempo sigue corriendo. ¬°Piensa bien antes de responder!"
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('hint-text').textContent = randomMessage;
            document.getElementById('hint-modal').classList.add('show');
        }

        function closeHintModal() {
            document.getElementById('hint-modal').classList.remove('show');
        }

        function finishGame() {
            clearInterval(gameState.timerInterval);
            
            const timeUsed = 3600 - gameState.timeRemaining;
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            
            document.getElementById('explorer-name').textContent = 
                prompt('¬°Felicidades! Introduce tu nombre:') || 'Explorador Valiente';
            document.getElementById('final-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('final-hints').textContent = 3 - gameState.hintsLeft;
            
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
        }

        function gameOver() {
            clearInterval(gameState.timerInterval);
            alert('¬°Se acab√≥ el tiempo! Pero no te preocupes, puedes intentarlo de nuevo.');
            location.reload();
        }

        // Prevent drag on other elements
        document.addEventListener('dragover', (e) => {
            if (!e.target.classList.contains('drop-zone')) {
                e.preventDefault();
            }
        });

        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('drag-over');
            }
        });
    </script>
</body>
</html>