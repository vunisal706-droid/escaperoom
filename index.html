<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Tesoro Perdido de las Capitulaciones - Escape Room Educativo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Pantalla de inicio */
        #inicio-screen {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        .logo-capitulin {
            width: 150px;
            height: 150px;
            margin: 0 auto 30px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .story-box {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            line-height: 1.8;
        }

        .level-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .level-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .level-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .start-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* HUD del juego */
        .game-hud {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #e74c3c;
        }

        .progress-bar {
            flex: 1;
            min-width: 200px;
        }

        .progress-track {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* Sala gen√©rica */
        .room {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .room-title {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .room-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .puzzle-container {
            min-height: 300px;
        }

        /* Botones */
        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        /* Biblioteca */
        .books-shelf {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .book {
            width: 70px;
            height: 100px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.9em;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
        }

        .book:hover {
            transform: translateY(-10px);
        }

        .book-red { background: linear-gradient(180deg, #e74c3c, #c0392b); }
        .book-blue { background: linear-gradient(180deg, #3498db, #2980b9); }
        .book-green { background: linear-gradient(180deg, #2ecc71, #27ae60); }
        .book-purple { background: linear-gradient(180deg, #9b59b6, #8e44ad); }
        .book-orange { background: linear-gradient(180deg, #e67e22, #d35400); }

        .text-fragment {
            background: #f8f9fa;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: grab;
            border: 2px dashed #ccc;
            transition: all 0.3s;
        }

        .text-fragment:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .text-fragment.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 200px;
            background: #f0f0f0;
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #e8e8ff;
        }

        /* Laboratorio */
        .operation-item {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.5em;
            flex-wrap: wrap;
        }

        .operation-input {
            width: 100px;
            padding: 10px;
            font-size: 1.2em;
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
        }

        /* Gimnasio */
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 30px auto;
        }

        .pattern-item {
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .pattern-item.mystery {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .pattern-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .pattern-option {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pattern-option:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .pattern-option.selected {
            border-color: #667eea;
            background: #e8e8ff;
        }

        /* Ciencias */
        .science-question {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .science-question h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .science-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .science-card {
            padding: 15px 25px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .science-card:hover {
            border-color: #667eea;
        }

        .science-card.selected {
            border-color: #667eea;
            background: #e8e8ff;
        }

        .science-card.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .science-card.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        /* Sala de Candados */
        .padlock-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .padlock {
            background: linear-gradient(145deg, #f0f0f0, #d5d5d5);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .padlock-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            letter-spacing: 10px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .padlock-hint {
            color: #666;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .padlock-input {
            width: 60px;
            height: 70px;
            font-size: 2em;
            text-align: center;
            border: 3px solid #667eea;
            border-radius: 10px;
            margin: 0 5px;
        }

        /* Sala de Familia */
        .family-question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .family-question {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .family-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .family-option {
            padding: 12px 20px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .family-option:hover {
            border-color: #667eea;
        }

        .family-option.selected {
            border-color: #667eea;
            background: #e8e8ff;
        }

        .family-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .family-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        /* Sala de Memoria */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 500px;
            margin: 30px auto;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .memory-card::before {
            content: '‚ùì';
            position: absolute;
        }

        .memory-card.flipped, .memory-card.matched {
            background: white;
            border: 3px solid #667eea;
        }

        .memory-card.flipped::before, .memory-card.matched::before {
            content: none;
        }

        .memory-card.matched {
            background: #d4edda;
            border-color: #28a745;
            cursor: default;
        }

        .memory-card-content {
            display: none;
        }

        .memory-card.flipped .memory-card-content,
        .memory-card.matched .memory-card-content {
            display: block;
        }

        .memory-stats {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
        }

        /* Sala del Ahorcado */
        .hangman-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .balloon-container {
            width: 200px;
            height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .balloon {
            font-size: 8em;
            transition: all 0.5s;
            filter: hue-rotate(0deg);
        }

        .balloon.stage-1 { transform: scale(1.1); filter: hue-rotate(30deg); }
        .balloon.stage-2 { transform: scale(1.2); filter: hue-rotate(60deg); }
        .balloon.stage-3 { transform: scale(1.3); filter: hue-rotate(90deg); }
        .balloon.stage-4 { transform: scale(1.4); filter: hue-rotate(120deg); }
        .balloon.stage-5 { transform: scale(1.5); filter: hue-rotate(150deg); }
        .balloon.stage-6 { 
            animation: explode 0.5s forwards;
        }

        @keyframes explode {
            0% { transform: scale(1.5); opacity: 1; }
            50% { transform: scale(2); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }

        .explosion-text {
            font-size: 3em;
            color: #e74c3c;
            font-weight: bold;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .word-display {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .letter-box {
            width: 50px;
            height: 60px;
            border-bottom: 4px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .keyboard {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 500px;
            margin: 20px auto;
        }

        .key {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #f0f0f0, #d5d5d5);
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .key:hover:not(:disabled) {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .key:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .key.correct {
            background: #28a745;
            color: white;
        }

        .key.wrong {
            background: #dc3545;
            color: white;
        }

        .hangman-category {
            text-align: center;
            background: #e8e8ff;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
        }

        /* Sala de la Balanza */
        .balance-puzzle {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .balance-equation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 2em;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .balance-item {
            font-size: 1.5em;
        }

        .balance-question {
            text-align: center;
            font-size: 1.5em;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
        }

        .balance-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .balance-option {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .balance-option:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .balance-option.selected {
            border-color: #667eea;
            background: #e8e8ff;
        }

        .balance-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .balance-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        /* Tesoro */
        .treasure-room {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
        }

        .treasure-room .room-title {
            color: white;
        }

        .treasure-chest {
            text-align: center;
            font-size: 8em;
            animation: float 3s ease-in-out infinite;
        }

        .code-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .code-digit {
            width: 60px;
            height: 80px;
            font-size: 2em;
            text-align: center;
            border: 3px solid white;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .code-digit::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* Certificado */
        .certificate {
            background: linear-gradient(135deg, #f5f5f5, #fff);
            border: 10px double #FFD700;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .certificate h2 {
            color: #667eea;
            margin: 20px 0;
        }

        .certificate-name {
            font-size: 2em;
            color: #f5576c;
            font-style: italic;
            margin: 20px 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .modal-capitulin {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .close-modal {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Animaciones de √©xito */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            font-size: 5em;
            animation: successPop 1s forwards;
            pointer-events: none;
            z-index: 2000;
        }

        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* Penalizaci√≥n visual */
        .penalty-flash {
            animation: penaltyFlash 0.5s ease-out;
        }

        @keyframes penaltyFlash {
            0%, 100% { background-color: inherit; }
            50% { background-color: #f8d7da; }
        }

        .penalty-text {
            color: #dc3545;
            font-weight: bold;
            animation: penaltyPulse 0.5s ease-out;
        }

        @keyframes penaltyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .room-title { font-size: 1.8em; }
            .pattern-grid { grid-template-columns: repeat(3, 1fr); }
            .code-digit { width: 50px; height: 70px; font-size: 1.8em; }
            .game-hud { flex-direction: column; }
            .padlock-container { gap: 20px; }
            .padlock { min-width: 150px; padding: 20px; }
            .padlock-number { font-size: 2em; letter-spacing: 5px; }
            .memory-grid { grid-template-columns: repeat(3, 1fr); }
            .balloon { font-size: 5em; }
            .hangman-container { flex-direction: column; align-items: center; }
        }

        .hidden {
            display: none;
        }

        /* Capitulin animado */
        .capitulin-helper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            animation: float 3s ease-in-out infinite;
            z-index: 100;
        }

        .feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de inicio -->
        <div id="inicio-screen">
            <div class="logo-capitulin">ü¶ä</div>
            <h1>El Tesoro Perdido de las Capitulaciones</h1>
            
            <div class="story-box">
                <p><strong>¬°Hola, aventurero!</strong></p>
                <p>Soy Capitul√≠n, la mascota del CEIP Capitulaciones. He encontrado un mapa antiguo que muestra la ubicaci√≥n de un tesoro escondido en nuestro cole.</p>
                <p>Pero hay un problema... el tesoro est√° protegido por enigmas en <strong>10 salas diferentes</strong>. Necesito tu ayuda para resolver todos los acertijos antes de que se acabe el tiempo.</p>
                <p><strong>‚ö†Ô∏è ¬°Cuidado! Si fallas alguna pregunta, perder√°s 5 minutos.</strong></p>
                <p><strong>¬øTe atreves a ayudarme? üó∫Ô∏èüíé</strong></p>
            </div>

            <h2 style="color: white; margin: 30px 0;">Selecciona tu nivel:</h2>
            <div class="level-selector">
                <button class="level-btn" onclick="selectLevel(1)">
                    1¬∫ - 2¬∫ Primaria<br>
                    <small>‚≠ê Nivel Principiante</small>
                </button>
                <button class="level-btn" onclick="selectLevel(2)">
                    3¬∫ - 4¬∫ Primaria<br>
                    <small>‚≠ê‚≠ê Nivel Intermedio</small>
                </button>
                <button class="level-btn" onclick="selectLevel(3)">
                    5¬∫ - 6¬∫ Primaria<br>
                    <small>‚≠ê‚≠ê‚≠ê Nivel Avanzado</small>
                </button>
            </div>

            <button class="start-btn" id="start-game-btn" onclick="startGame()" disabled>
                üöÄ ¬°Comenzar Aventura!
            </button>
        </div>

        <!-- Pantalla del juego -->
        <div id="game-screen" class="hidden">
            <!-- HUD -->
            <div class="game-hud">
                <div class="timer">‚è±Ô∏è <span id="timer">60:00</span></div>
                <div class="progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="progress" style="width: 0%">
                            <span id="progress-text">0/10 Salas</span>
                        </div>
                    </div>
                </div>
                <div class="hints-counter">üí° Pistas: <span id="hints-left">3</span></div>
            </div>

            <!-- Salas -->
            <div id="room-container"></div>

            <!-- Bot√≥n de Capitul√≠n -->
            <div class="capitulin-helper" onclick="showCapitulinHelp()" title="¬øNecesitas ayuda?">
                ü¶ä
            </div>
        </div>

        <!-- Pantalla final -->
        <div id="final-screen" class="hidden">
            <div class="certificate">
                <div style="font-size: 5em;">üèÜ</div>
                <h2>¬°CERTIFICADO DE EXPLORADOR!</h2>
                <p>Por la presente se certifica que</p>
                <p class="certificate-name" id="explorer-name">Explorador Valiente</p>
                <p>ha completado con √©xito</p>
                <p><strong>El Tesoro Perdido de las Capitulaciones</strong></p>
                <p>Tiempo: <span id="final-time">--:--</span></p>
                <p>Pistas usadas: <span id="final-hints">0</span></p>
                <p style="margin-top: 30px; font-size: 3em;">ü¶ä</p>
                <p><em>Capitul√≠n - CEIP Capitulaciones</em></p>
                <button class="btn btn-primary" onclick="location.reload()">üîÑ Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <!-- Modal de pista -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <div class="modal-capitulin">ü¶ä</div>
            <h2>Pista de Capitul√≠n</h2>
            <p id="hint-text"></p>
            <button class="close-modal" onclick="closeHintModal()">Entendido</button>
        </div>
    </div>

    <!-- Modal de √©xito de sala -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-capitulin">üéâ</div>
            <h2>¬°Sala Completada!</h2>
            <p id="success-text"></p>
            <p><strong>C√≥digo obtenido: <span id="code-found" style="color: #f5576c; font-size: 2em;"></span></strong></p>
            <button class="close-modal" onclick="nextRoom()">Siguiente Sala ‚û°Ô∏è</button>
        </div>
    </div>

    <script>
        // Estado del juego
        const gameState = {
            level: 0,
            currentRoom: 0,
            timeRemaining: 3600, // 60 minutos en segundos
            hintsLeft: 3,
            codes: [],
            timerInterval: null,
            roomsCompleted: 0,
            totalRooms: 10
        };

        // ==================== BANCO DE PALABRAS AHORCADO ====================
        const hangmanWords = {
            1: [ // Nivel 1 - Palabras cortas y f√°ciles
                { word: "SOL", category: "Naturaleza" },
                { word: "MAR", category: "Naturaleza" },
                { word: "PEZ", category: "Animales" },
                { word: "OSO", category: "Animales" },
                { word: "LUNA", category: "Naturaleza" },
                { word: "CASA", category: "Objetos" },
                { word: "MESA", category: "Objetos" },
                { word: "GATO", category: "Animales" },
                { word: "PERRO", category: "Animales" },
                { word: "LIBRO", category: "Escuela" },
                { word: "LAPIZ", category: "Escuela" },
                { word: "AGUA", category: "Naturaleza" },
                { word: "FLOR", category: "Naturaleza" },
                { word: "ARBOL", category: "Naturaleza" },
                { word: "ROJO", category: "Colores" },
                { word: "AZUL", category: "Colores" },
                { word: "VERDE", category: "Colores" },
                { word: "NUBE", category: "Naturaleza" },
                { word: "MANO", category: "Cuerpo" },
                { word: "PIE", category: "Cuerpo" },
                { word: "BOCA", category: "Cuerpo" },
                { word: "NARIZ", category: "Cuerpo" },
                { word: "SILLA", category: "Objetos" },
                { word: "PUERTA", category: "Objetos" },
                { word: "COCHE", category: "Veh√≠culos" },
                { word: "TREN", category: "Veh√≠culos" },
                { word: "AVION", category: "Veh√≠culos" },
                { word: "LEON", category: "Animales" },
                { word: "MONO", category: "Animales" },
                { word: "RANA", category: "Animales" }
            ],
            2: [ // Nivel 2 - Palabras intermedias
                { word: "ESCUELA", category: "Lugares" },
                { word: "MARIPOSA", category: "Animales" },
                { word: "ELEFANTE", category: "Animales" },
                { word: "COCODRILO", category: "Animales" },
                { word: "BIBLIOTECA", category: "Lugares" },
                { word: "ORDENADOR", category: "Tecnolog√≠a" },
                { word: "CUADERNO", category: "Escuela" },
                { word: "PIZARRA", category: "Escuela" },
                { word: "RECREO", category: "Escuela" },
                { word: "FAMILIA", category: "Personas" },
                { word: "AMIGOS", category: "Personas" },
                { word: "COLEGIO", category: "Lugares" },
                { word: "PLANETA", category: "Ciencia" },
                { word: "ESTRELLA", category: "Naturaleza" },
                { word: "MONTA√ëA", category: "Naturaleza" },
                { word: "CASCADA", category: "Naturaleza" },
                { word: "OCEANO", category: "Naturaleza" },
                { word: "DINOSAURIO", category: "Animales" },
                { word: "JIRAFA", category: "Animales" },
                { word: "PING√úINO", category: "Animales" },
                { word: "TORTUGA", category: "Animales" },
                { word: "TELEFONO", category: "Tecnolog√≠a" },
                { word: "GUITARRA", category: "M√∫sica" },
                { word: "PINTURA", category: "Arte" },
                { word: "DEPORTES", category: "Actividades" },
                { word: "BICICLETA", category: "Veh√≠culos" },
                { word: "HOSPITAL", category: "Lugares" },
                { word: "MERCADO", category: "Lugares" },
                { word: "CHOCOLATE", category: "Comida" },
                { word: "HELADO", category: "Comida" }
            ],
            3: [ // Nivel 3 - Palabras dif√≠ciles
                { word: "CAPITULACIONES", category: "Historia" },
                { word: "DESCUBRIMIENTO", category: "Historia" },
                { word: "CRISTOBAL", category: "Historia" },
                { word: "MEDITERRANEO", category: "Geograf√≠a" },
                { word: "ANDALUCIA", category: "Geograf√≠a" },
                { word: "EXTRATERRESTRE", category: "Ciencia ficci√≥n" },
                { word: "MULTIPLICACION", category: "Matem√°ticas" },
                { word: "RECTANGULO", category: "Geometr√≠a" },
                { word: "CIRCUNFERENCIA", category: "Geometr√≠a" },
                { word: "FOTOSINTESIS", category: "Ciencia" },
                { word: "ECOSISTEMA", category: "Ciencia" },
                { word: "VERTEBRADO", category: "Ciencia" },
                { word: "INVERTEBRADO", category: "Ciencia" },
                { word: "DEMOCRACIA", category: "Sociedad" },
                { word: "CONSTITUCI√ìN", category: "Sociedad" },
                { word: "RENACIMIENTO", category: "Historia" },
                { word: "ARQUITECTURA", category: "Arte" },
                { word: "ESCULTURA", category: "Arte" },
                { word: "INSTRUMENTO", category: "M√∫sica" },
                { word: "ORQUESTA", category: "M√∫sica" },
                { word: "ELECTRICIDAD", category: "Ciencia" },
                { word: "MAGNETISMO", category: "Ciencia" },
                { word: "EVAPORACION", category: "Ciencia" },
                { word: "CONDENSACION", category: "Ciencia" },
                { word: "PRECIPITACION", category: "Ciencia" },
                { word: "TEMPERATURA", category: "Ciencia" },
                { word: "CIVILIZACION", category: "Historia" },
                { word: "PREHISTORIA", category: "Historia" },
                { word: "CONTINENTE", category: "Geograf√≠a" },
                { word: "ATMOSFERA", category: "Ciencia" }
            ]
        };

        // ==================== PUZZLES DE BALANZA ====================
        const balancePuzzles = {
            1: [ // Nivel 1
                {
                    equations: [
                        { left: "üçé + üçé", right: "4" },
                        { left: "üçä + üçä + üçä", right: "6" }
                    ],
                    question: "¬øCu√°nto vale üçé + üçä?",
                    options: [3, 4, 5, 6],
                    answer: 4 // üçé=2, üçä=2, 2+2=4
                },
                {
                    equations: [
                        { left: "‚≠ê + ‚≠ê + ‚≠ê", right: "9" },
                        { left: "üåô", right: "5" }
                    ],
                    question: "¬øCu√°nto vale ‚≠ê + üåô?",
                    options: [6, 7, 8, 9],
                    answer: 8 // ‚≠ê=3, üåô=5, 3+5=8
                },
                {
                    equations: [
                        { left: "üê± + üê±", right: "6" },
                        { left: "üê∂", right: "4" }
                    ],
                    question: "¬øCu√°nto vale üê± + üê∂?",
                    options: [5, 6, 7, 8],
                    answer: 7 // üê±=3, üê∂=4, 3+4=7
                }
            ],
            2: [ // Nivel 2
                {
                    equations: [
                        { left: "üçï + üçï + üçî", right: "11" },
                        { left: "üçî + üçî", right: "6" }
                    ],
                    question: "¬øCu√°nto vale üçï?",
                    options: [3, 4, 5, 6],
                    answer: 4 // üçî=3, üçï+üçï+3=11, üçï=4
                },
                {
                    equations: [
                        { left: "üéà + üéà + üéà", right: "15" },
                        { left: "üéà + üéÅ", right: "9" }
                    ],
                    question: "¬øCu√°nto vale üéÅ?",
                    options: [2, 3, 4, 5],
                    answer: 4 // üéà=5, 5+üéÅ=9, üéÅ=4
                },
                {
                    equations: [
                        { left: "üöó + üöó", right: "14" },
                        { left: "üöó + üöå", right: "17" }
                    ],
                    question: "¬øCu√°nto vale üöå?",
                    options: [8, 9, 10, 11],
                    answer: 10 // üöó=7, 7+üöå=17, üöå=10
                }
            ],
            3: [ // Nivel 3
                {
                    equations: [
                        { left: "üî∑ + üî∑ + üî∂", right: "17" },
                        { left: "üî∂ + üî∂", right: "14" },
                        { left: "üî∑ + üî∂ + ‚¨ü", right: "15" }
                    ],
                    question: "¬øCu√°nto vale ‚¨ü?",
                    options: [3, 4, 5, 6],
                    answer: 5 // üî∂=7, üî∑+üî∑+7=17‚Üíüî∑=5, 5+7+‚¨ü=15‚Üí‚¨ü=3... wait let me recalculate
                    // üî∂=7, üî∑+üî∑=10‚Üíüî∑=5, 5+7+‚¨ü=15‚Üí‚¨ü=3
                    // Actually answer should be 3
                },
                {
                    equations: [
                        { left: "üå∫ + üå∫ + üå∫", right: "24" },
                        { left: "üå∫ + üåª + üåª", right: "22" },
                        { left: "üåª + üåº", right: "12" }
                    ],
                    question: "¬øCu√°nto vale üåº?",
                    options: [5, 6, 7, 8],
                    answer: 7 // üå∫=8, 8+üåª+üåª=22‚Üíüåª=7, 7+üåº=12‚Üíüåº=5... wait
                    // üå∫=8, üåª+üåª=14‚Üíüåª=7, üåº=5... answer should be 5
                },
                {
                    equations: [
                        { left: "üìö + üìö + üìö", right: "18" },
                        { left: "üìö + ‚úèÔ∏è", right: "10" },
                        { left: "‚úèÔ∏è + ‚úèÔ∏è + üìê", right: "13" }
                    ],
                    question: "¬øCu√°nto vale üìê?",
                    options: [3, 4, 5, 6],
                    answer: 5 // üìö=6, ‚úèÔ∏è=4, 4+4+üìê=13‚Üíüìê=5
                }
            ]
        };
        // Fix balance puzzles level 3
        balancePuzzles[3][0].answer = 3;
        balancePuzzles[3][1].answer = 5;

        // ==================== PREGUNTAS DE FAMILIA ====================
        const familyQuestionsPool = [
            // Nivel 1 - F√°ciles
            { level: 1, question: "Si tu mam√° tiene una hermana, ¬øqu√© es ella para ti?", options: ["Mi t√≠a", "Mi prima", "Mi abuela", "Mi hermana"], correct: 0 },
            { level: 1, question: "El pap√° de tu mam√° es tu...", options: ["T√≠o", "Primo", "Abuelo", "Hermano"], correct: 2 },
            { level: 1, question: "La hija de tus padres es tu...", options: ["Prima", "T√≠a", "Hermana", "Sobrina"], correct: 2 },
            { level: 1, question: "El hijo de tu t√≠a es tu...", options: ["Hermano", "Primo", "Sobrino", "T√≠o"], correct: 1 },
            { level: 1, question: "La mam√° de tu pap√° es tu...", options: ["T√≠a", "Abuela", "Hermana", "Prima"], correct: 1 },
            { level: 1, question: "El hermano de tu pap√° es tu...", options: ["Abuelo", "Primo", "T√≠o", "Sobrino"], correct: 2 },
            { level: 1, question: "Los padres de tus padres son tus...", options: ["T√≠os", "Primos", "Hermanos", "Abuelos"], correct: 3 },
            { level: 1, question: "La hermana de tu mam√° es tu...", options: ["Abuela", "T√≠a", "Prima", "Sobrina"], correct: 1 },
            // Nivel 2 - Intermedias
            { level: 2, question: "El hijo de tu hermano es tu...", options: ["Primo", "Sobrino", "Nieto", "T√≠o"], correct: 1 },
            { level: 2, question: "La madre de tu primo es tu...", options: ["Abuela", "T√≠a", "Prima", "Hermana"], correct: 1 },
            { level: 2, question: "El padre de tu t√≠o es tu...", options: ["Bisabuelo", "Abuelo", "T√≠o abuelo", "Primo"], correct: 1 },
            { level: 2, question: "La hija de tu abuela es tu...", options: ["Hermana", "Prima", "Madre o t√≠a", "Sobrina"], correct: 2 },
            { level: 2, question: "El hermano de tu abuelo es tu...", options: ["T√≠o", "T√≠o abuelo", "Primo", "Bisabuelo"], correct: 1 },
            { level: 2, question: "Los hijos de tus t√≠os son tus...", options: ["Hermanos", "Sobrinos", "Primos", "Nietos"], correct: 2 },
            { level: 2, question: "El padre del padre de tu padre es tu...", options: ["Abuelo", "Bisabuelo", "T√≠o abuelo", "Tatarabuelo"], correct: 1 },
            { level: 2, question: "La hija de tu hermana es tu...", options: ["Prima", "Nieta", "Sobrina", "T√≠a"], correct: 2 },
            // Nivel 3 - Dif√≠ciles
            { level: 3, question: "¬øQui√©n es para ti el hijo de la hermana de tu madre?", options: ["Tu hermano", "Tu primo", "Tu sobrino", "Tu t√≠o"], correct: 1 },
            { level: 3, question: "¬øQu√© parentesco tiene contigo el abuelo de tu primo?", options: ["Tu bisabuelo", "Tu abuelo", "Tu t√≠o abuelo", "Ninguno directo"], correct: 1 },
            { level: 3, question: "Si tu t√≠a tiene un hijo, ¬øqu√© es el hijo de ese hijo para ti?", options: ["Primo segundo", "Sobrino", "Primo", "Sobrino nieto"], correct: 0 },
            { level: 3, question: "¬øQui√©n es para ti la madre del marido de tu hermana?", options: ["Tu suegra", "Tu t√≠a", "Tu consuegra", "Ning√∫n parentesco"], correct: 3 },
            { level: 3, question: "El hijo de tu bisabuelo que no es tu abuelo es tu...", options: ["T√≠o", "T√≠o abuelo", "Primo", "Bisabuelo"], correct: 1 },
            { level: 3, question: "¬øQu√© son entre s√≠ los hijos de dos hermanos?", options: ["Hermanos", "Primos hermanos", "Primos segundos", "Sobrinos"], correct: 1 },
            { level: 3, question: "La nuera de tu abuela puede ser tu...", options: ["T√≠a", "Madre", "Madre o t√≠a", "Prima"], correct: 2 },
            { level: 3, question: "¬øQu√© parentesco tienes con el padre del esposo de tu t√≠a?", options: ["Abuelo", "T√≠o", "Ning√∫n parentesco", "Consuegro"], correct: 2 }
        ];

        // ==================== PUZZLES DE CANDADOS ====================
        const padlockPuzzles = {
            1: {
                clue1: { number: "123", hint: "Un n√∫mero correcto y bien colocado" },
                clue2: { number: "456", hint: "Nada correcto" },
                clue3: { number: "178", hint: "Dos n√∫meros correctos pero mal colocados" },
                answer: "817"
            },
            2: {
                clue1: { number: "291", hint: "Un n√∫mero correcto pero mal colocado" },
                clue2: { number: "245", hint: "Un n√∫mero correcto pero mal colocado" },
                clue3: { number: "463", hint: "Dos n√∫meros correctos pero mal colocados" },
                answer: "642"
            },
            3: {
                clue1: { number: "147", hint: "Un n√∫mero correcto y bien colocado" },
                clue2: { number: "189", hint: "Un n√∫mero correcto pero mal colocado" },
                clue3: { number: "964", hint: "Dos n√∫meros correctos, uno bien colocado" },
                answer: "941"
            }
        };

        // ==================== CONTENIDO POR NIVEL ====================
        const levelContent = {
            1: { // 1¬∫-2¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "Nuestro colegio",
                        "se llama CEIP Capitulaciones",
                        "y est√° en",
                        "Santa Fe, Granada"
                    ],
                    palabra: "CEIP"
                },
                laboratorio: [
                    { problem: "3 + 4", answer: 7 },
                    { problem: "8 - 3", answer: 5 },
                    { problem: "2 √ó 3", answer: 6 },
                    { problem: "10 √∑ 2", answer: 5 }
                ],
                gimnasio: {
                    sequence: ["üî¥", "üîµ", "üî¥", "üîµ", "üî¥", "‚ùì"],
                    answer: "üîµ"
                },
                ciencias: [
                    { question: "¬øCu√°ntas patas tiene un perro?", answers: ["2", "4", "6"], correct: [1] },
                    { question: "¬øDe qu√© color es el sol?", answers: ["Azul", "Verde", "Amarillo"], correct: [2] }
                ],
                memory: ["üçé", "üçä", "üçã", "üçá", "üçì", "üçå"]
            },
            2: { // 3¬∫-4¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "Los Reyes Cat√≥licos",
                        "firmaron las Capitulaciones",
                        "con Crist√≥bal Col√≥n",
                        "en Santa Fe, Granada",
                        "para descubrir nuevas tierras"
                    ],
                    palabra: "HISTORIA"
                },
                laboratorio: [
                    { problem: "23 + 45", answer: 68 },
                    { problem: "89 - 34", answer: 55 },
                    { problem: "7 √ó 8", answer: 56 },
                    { problem: "48 √∑ 6", answer: 8 }
                ],
                gimnasio: {
                    sequence: ["‚¨õ", "‚¨ú", "‚¨õ", "‚¨ú", "‚¨õ", "‚ùì"],
                    answer: "‚¨ú"
                },
                ciencias: [
                    { question: "Estados del agua:", answers: ["S√≥lido", "L√≠quido", "Gaseoso"], correct: [0, 1, 2] },
                    { question: "Planeta m√°s cercano al Sol:", answers: ["Mercurio", "Venus", "Tierra"], correct: [0] }
                ],
                memory: ["ü¶Å", "üêò", "ü¶í", "üê¨", "ü¶ã", "üê¢"]
            },
            3: { // 5¬∫-6¬∫ Primaria
                biblioteca: {
                    fragments: [
                        "Las Capitulaciones de Santa Fe fueron",
                        "un acuerdo hist√≥rico firmado",
                        "entre los Reyes Cat√≥licos",
                        "y Crist√≥bal Col√≥n en 1492",
                        "que permiti√≥ el descubrimiento de Am√©rica"
                    ],
                    palabra: "AM√âRICA"
                },
                laboratorio: [
                    { problem: "125 + 378", answer: 503 },
                    { problem: "456 - 189", answer: 267 },
                    { problem: "23 √ó 12", answer: 276 },
                    { problem: "144 √∑ 12", answer: 12 }
                ],
                gimnasio: {
                    sequence: ["2", "4", "8", "16", "‚ùì"],
                    answer: "32"
                },
                ciencias: [
                    { question: "Tipos de energ√≠a:", answers: ["Solar", "E√≥lica", "Nuclear"], correct: [0, 1, 2] },
                    { question: "√ìrgano que bombea sangre:", answers: ["Coraz√≥n", "Pulm√≥n", "H√≠gado"], correct: [0] }
                ],
                memory: ["üî¨", "üß¨", "‚öóÔ∏è", "üî≠", "üß≤", "üí°"]
            }
        };

        // ==================== PISTAS ====================
        const hints = [
            [ // Nivel 1
                "Lee cada fragmento con cuidado y piensa en el orden l√≥gico.",
                "Observa el patr√≥n: ¬øqu√© elemento se repite?",
                "Recuerda d√≥nde has visto cada carta.",
                "¬øCu√°les son las operaciones matem√°ticas b√°sicas?",
                "Piensa en las letras que m√°s se usan en espa√±ol.",
                "Si dos cosas pesan igual, ¬°valen lo mismo!",
                "Lee cada pregunta dos veces antes de responder.",
                "Piensa en las pistas: ¬øqu√© n√∫meros NO pueden ser?",
                "Dibuja tu √°rbol familiar para entender mejor.",
                "Usa los n√∫meros que encontraste en orden."
            ],
            [ // Nivel 2
                "Los fragmentos cuentan algo importante sobre nuestro cole.",
                "Mira la secuencia completa: ¬øcu√°l es el patr√≥n?",
                "Intenta recordar las posiciones de las parejas.",
                "Recuerda las tablas de multiplicar.",
                "Las vocales aparecen mucho en las palabras.",
                "Resuelve primero las ecuaciones m√°s sencillas.",
                "Algunas preguntas pueden tener varias respuestas.",
                "Elimina los n√∫meros que seguro NO est√°n.",
                "Tu suegra es la madre de tu esposo/a.",
                "Revisa todos los c√≥digos en orden."
            ],
            [ // Nivel 3
                "Este texto habla de un momento hist√≥rico muy importante.",
                "Esta secuencia sigue una regla matem√°tica. ¬øCu√°l?",
                "Conc√©ntrate y memoriza las posiciones.",
                "Usa multiplicaci√≥n y divisi√≥n para verificar.",
                "Piensa en consonantes poco comunes: Q, X, Z...",
                "Sustituye los valores conocidos en las ecuaciones.",
                "Piensa en lo que has aprendido en Ciencias.",
                "Usa l√≥gica: si est√° mal colocado, prueba otra posici√≥n.",
                "Piensa paso a paso: primero identifica qui√©n es qui√©n.",
                "Introduce los nueve d√≠gitos que obtuviste."
            ]
        ];

        // ==================== FUNCIONES PRINCIPALES ====================
        function selectLevel(level) {
            gameState.level = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.style.opacity = '0.5';
            });
            event.target.style.opacity = '1';
            document.getElementById('start-game-btn').disabled = false;
        }

        function startGame() {
            if (gameState.level === 0) {
                alert('Por favor, selecciona un nivel primero');
                return;
            }

            document.getElementById('inicio-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            startTimer();
            loadRoom(0);
        }

        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimer();
                
                if (gameState.timeRemaining <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (gameState.timeRemaining <= 300) {
                document.getElementById('timer').style.color = '#e74c3c';
            }
        }

        function applyPenalty() {
            gameState.timeRemaining -= 300; // 5 minutos
            if (gameState.timeRemaining < 0) gameState.timeRemaining = 0;
            updateTimer();
            
            const timer = document.getElementById('timer');
            timer.classList.add('penalty-text');
            setTimeout(() => timer.classList.remove('penalty-text'), 500);
            
            const room = document.querySelector('.room');
            if (room) {
                room.classList.add('penalty-flash');
                setTimeout(() => room.classList.remove('penalty-flash'), 500);
            }
        }

        function updateProgress() {
            const progress = (gameState.roomsCompleted / gameState.totalRooms) * 100;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `${gameState.roomsCompleted}/${gameState.totalRooms} Salas`;
        }

        function loadRoom(roomIndex) {
            const container = document.getElementById('room-container');
            gameState.currentRoom = roomIndex;

            const rooms = [
                createBibliotecaRoom,      // 0 - Biblioteca
                createGimnasioRoom,        // 1 - Gimnasio (secuencias)
                createMemoriaRoom,         // 2 - Memoria (NUEVA)
                createLaboratorioRoom,     // 3 - Laboratorio
                createAhorcadoRoom,        // 4 - Ahorcado (NUEVA)
                createBalanzaRoom,         // 5 - Balanza (NUEVA)
                createCienciasRoom,        // 6 - Ciencias
                createCandadosRoom,        // 7 - Candados
                createFamiliaRoom,         // 8 - Familia
                createTesoroRoom           // 9 - Tesoro
            ];

            container.innerHTML = '';
            rooms[roomIndex]();
        }

        // ==================== SALA 1: BIBLIOTECA ====================
        function createBibliotecaRoom() {
            const content = levelContent[gameState.level].biblioteca;
            const container = document.getElementById('room-container');
            
            // Mezclar fragmentos
            const shuffledFragments = [...content.fragments].sort(() => Math.random() - 0.5);
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üìö La Biblioteca del Saber</h2>
                    <p class="room-subtitle">Ordena los fragmentos para descubrir la historia</p>
                    
                    <div class="puzzle-container">
                        <div id="fragments-source" style="margin: 20px 0;">
                            ${shuffledFragments.map((frag, i) => 
                                `<div class="text-fragment" draggable="true" data-text="${frag}" 
                                     ondragstart="drag(event)" id="frag-${i}">${frag}</div>`
                            ).join('')}
                        </div>

                        <h3>Historia ordenada:</h3>
                        <div class="drop-zone" id="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                            <p style="color: #999; text-align: center;">Arrastra los fragmentos aqu√≠ en orden correcto</p>
                        </div>

                        <div id="biblioteca-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(0)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkBiblioteca()">‚úì Comprobar Orden</button>
                    </div>
                </div>
            `;
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        }

        function drop(ev) {
            ev.preventDefault();
            ev.target.classList.remove('drag-over');
            const data = ev.dataTransfer.getData("text");
            const element = document.getElementById(data);
            element.classList.remove('dragging');
            
            const dropZone = document.getElementById('drop-zone');
            const placeholder = dropZone.querySelector('p');
            if (placeholder) placeholder.remove();
            
            dropZone.appendChild(element);
        }

        function checkBiblioteca() {
            const content = levelContent[gameState.level].biblioteca;
            const dropZone = document.getElementById('drop-zone');
            const fragments = dropZone.querySelectorAll('.text-fragment');
            
            if (fragments.length !== content.fragments.length) {
                showFeedback('biblioteca-feedback', 'Arrastra todos los fragmentos a la zona de orden', false);
                return;
            }

            let correct = true;
            fragments.forEach((frag, i) => {
                if (frag.dataset.text !== content.fragments[i]) {
                    correct = false;
                }
            });

            if (correct) {
                showFeedback('biblioteca-feedback', '¬°Correcto! Has ordenado la historia perfectamente.', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Excelente trabajo ordenando la historia!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('biblioteca-feedback', '‚ùå El orden no es correcto. -5 minutos. Piensa en la secuencia l√≥gica.', false);
            }
        }

        // ==================== SALA 2: GIMNASIO (Secuencias) ====================
        function createGimnasioRoom() {
            const content = levelContent[gameState.level].gimnasio;
            const container = document.getElementById('room-container');
            
            // Opciones de respuesta
            let options;
            if (gameState.level === 1) {
                options = ["üî¥", "üîµ", "üü¢", "üü°"];
            } else if (gameState.level === 2) {
                options = ["‚¨õ", "‚¨ú", "üü´", "üü¶"];
            } else {
                options = ["32", "24", "20", "64"];
            }
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üèÉ El Gimnasio de las Secuencias</h2>
                    <p class="room-subtitle">Completa el patr√≥n l√≥gico</p>
                    
                    <div class="puzzle-container">
                        <div class="pattern-grid">
                            ${content.sequence.map(item => `
                                <div class="pattern-item ${item === '‚ùì' ? 'mystery' : ''}">${item}</div>
                            `).join('')}
                        </div>

                        <h3 style="text-align: center; margin: 20px 0;">¬øQu√© sigue en la secuencia?</h3>
                        
                        <div class="pattern-options">
                            ${options.map(opt => `
                                <div class="pattern-option" onclick="selectPattern('${opt}')" data-option="${opt}">${opt}</div>
                            `).join('')}
                        </div>

                        <div id="gimnasio-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(1)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkGimnasio()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        function selectPattern(option) {
            document.querySelectorAll('.pattern-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.pattern-option[data-option="${option}"]`).classList.add('selected');
            window.selectedPattern = option;
        }

        function checkGimnasio() {
            const content = levelContent[gameState.level].gimnasio;
            
            if (!window.selectedPattern) {
                showFeedback('gimnasio-feedback', 'Selecciona una opci√≥n primero', false);
                return;
            }

            if (window.selectedPattern === content.answer) {
                showFeedback('gimnasio-feedback', '¬°Correcto! Has completado la secuencia.', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Muy bien identificando el patr√≥n!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('gimnasio-feedback', '‚ùå Esa no es la respuesta correcta. -5 minutos.', false);
            }
        }

        // ==================== SALA 3: MEMORIA (NUEVA) ====================
        function createMemoriaRoom() {
            const content = levelContent[gameState.level].memory;
            const container = document.getElementById('room-container');
            
            // Crear pares y mezclar
            const cards = [...content, ...content];
            const shuffledCards = cards.sort(() => Math.random() - 0.5);
            
            window.memoryCards = shuffledCards;
            window.flippedCards = [];
            window.matchedPairs = 0;
            window.memoryAttempts = 0;
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üß† La Sala de la Memoria</h2>
                    <p class="room-subtitle">Encuentra las 6 parejas de cartas</p>
                    
                    <div class="memory-stats">
                        Parejas encontradas: <span id="pairs-found">0</span>/6 | 
                        Intentos: <span id="memory-attempts">0</span>
                    </div>
                    
                    <div class="puzzle-container">
                        <div class="memory-grid">
                            ${shuffledCards.map((card, i) => `
                                <div class="memory-card" data-index="${i}" data-symbol="${card}" onclick="flipCard(${i})">
                                    <span class="memory-card-content">${card}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div id="memoria-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(2)">üí° Pedir Pista</button>
                    </div>
                </div>
            `;
        }

        function flipCard(index) {
            const card = document.querySelector(`.memory-card[data-index="${index}"]`);
            
            // No voltear si ya est√° volteada o emparejada
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
            
            // No voltear m√°s de 2 cartas
            if (window.flippedCards.length >= 2) return;
            
            card.classList.add('flipped');
            window.flippedCards.push({ index, symbol: card.dataset.symbol, element: card });
            
            if (window.flippedCards.length === 2) {
                window.memoryAttempts++;
                document.getElementById('memory-attempts').textContent = window.memoryAttempts;
                
                const [card1, card2] = window.flippedCards;
                
                if (card1.symbol === card2.symbol) {
                    // ¬°Pareja encontrada!
                    setTimeout(() => {
                        card1.element.classList.add('matched');
                        card2.element.classList.add('matched');
                        window.matchedPairs++;
                        document.getElementById('pairs-found').textContent = window.matchedPairs;
                        window.flippedCards = [];
                        
                        if (window.matchedPairs === 6) {
                            showFeedback('memoria-feedback', '¬°Excelente memoria! Has encontrado todas las parejas.', true);
                            setTimeout(() => {
                                const code = Math.floor(Math.random() * 9) + 1;
                                gameState.codes.push(code);
                                completeRoom(code, `¬°Completado en ${window.memoryAttempts} intentos!`);
                            }, 1000);
                        }
                    }, 300);
                } else {
                    // No coinciden
                    setTimeout(() => {
                        card1.element.classList.remove('flipped');
                        card2.element.classList.remove('flipped');
                        window.flippedCards = [];
                    }, 1000);
                }
            }
        }

        // ==================== SALA 4: LABORATORIO ====================
        function createLaboratorioRoom() {
            const content = levelContent[gameState.level].laboratorio;
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üî¨ El Laboratorio Matem√°tico</h2>
                    <p class="room-subtitle">Resuelve las operaciones para abrir la puerta</p>
                    
                    <div class="puzzle-container">
                        ${content.map((op, i) => `
                            <div class="operation-item">
                                <span>${op.problem}</span>
                                <span>=</span>
                                <input type="number" class="operation-input" id="op-${i}" placeholder="?">
                            </div>
                        `).join('')}

                        <div id="laboratorio-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(3)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkLaboratorio()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        function checkLaboratorio() {
            const content = levelContent[gameState.level].laboratorio;
            let allCorrect = true;

            content.forEach((op, i) => {
                const input = document.getElementById(`op-${i}`);
                const userAnswer = parseInt(input.value);
                
                if (userAnswer === op.answer) {
                    input.style.borderColor = '#28a745';
                    input.style.background = '#d4edda';
                } else {
                    input.style.borderColor = '#dc3545';
                    input.style.background = '#f8d7da';
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                showFeedback('laboratorio-feedback', '¬°Todas las operaciones correctas!', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Eres un genio matem√°tico!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('laboratorio-feedback', '‚ùå Algunas respuestas son incorrectas. -5 minutos.', false);
            }
        }

        // ==================== SALA 5: AHORCADO (NUEVA) ====================
        function createAhorcadoRoom() {
            const words = hangmanWords[gameState.level];
            const wordData = words[Math.floor(Math.random() * words.length)];
            
            window.hangmanWord = wordData.word;
            window.hangmanCategory = wordData.category;
            window.hangmanGuessed = [];
            window.hangmanErrors = 0;
            
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üéà La Sala del Globo</h2>
                    <p class="room-subtitle">Adivina la palabra antes de que el globo explote</p>
                    
                    <div class="puzzle-container">
                        <div class="hangman-category">Categor√≠a: <strong>${wordData.category}</strong></div>
                        
                        <div class="hangman-container">
                            <div class="balloon-container">
                                <div class="balloon" id="balloon">üéà</div>
                                <div id="explosion-text"></div>
                            </div>
                            
                            <div>
                                <div class="word-display" id="word-display">
                                    ${wordData.word.split('').map(() => '<div class="letter-box">_</div>').join('')}
                                </div>
                                
                                <p style="text-align: center; color: #666;">Errores: <span id="error-count">0</span>/6</p>
                                
                                <div class="keyboard" id="keyboard">
                                    ${'ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ'.split('').map(letter => 
                                        `<button class="key" onclick="guessLetter('${letter}')">${letter}</button>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>

                        <div id="ahorcado-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(4)">üí° Pedir Pista</button>
                    </div>
                </div>
            `;
        }

        function guessLetter(letter) {
            if (window.hangmanGuessed.includes(letter)) return;
            
            window.hangmanGuessed.push(letter);
            const key = document.querySelector(`.key:not(:disabled)`);
            const allKeys = document.querySelectorAll('.key');
            allKeys.forEach(k => {
                if (k.textContent === letter) {
                    k.disabled = true;
                }
            });
            
            if (window.hangmanWord.includes(letter)) {
                // Letra correcta
                document.querySelectorAll('.key').forEach(k => {
                    if (k.textContent === letter) k.classList.add('correct');
                });
                
                updateWordDisplay();
                
                // Verificar si gan√≥
                const displayLetters = document.querySelectorAll('.letter-box');
                const allRevealed = [...displayLetters].every(box => box.textContent !== '_');
                
                if (allRevealed) {
                    showFeedback('ahorcado-feedback', '¬°Felicidades! Has adivinado la palabra.', true);
                    setTimeout(() => {
                        const code = Math.floor(Math.random() * 9) + 1;
                        gameState.codes.push(code);
                        completeRoom(code, `¬°La palabra era "${window.hangmanWord}"!`);
                    }, 1000);
                }
            } else {
                // Letra incorrecta
                window.hangmanErrors++;
                document.getElementById('error-count').textContent = window.hangmanErrors;
                document.querySelectorAll('.key').forEach(k => {
                    if (k.textContent === letter) k.classList.add('wrong');
                });
                
                // Actualizar globo
                const balloon = document.getElementById('balloon');
                balloon.className = 'balloon stage-' + window.hangmanErrors;
                
                if (window.hangmanErrors >= 6) {
                    // ¬°Explot√≥!
                    setTimeout(() => {
                        balloon.style.display = 'none';
                        document.getElementById('explosion-text').innerHTML = '<span class="explosion-text">üí• BOOM!</span>';
                        
                        // Revelar palabra
                        const letters = window.hangmanWord.split('');
                        const boxes = document.querySelectorAll('.letter-box');
                        letters.forEach((letter, i) => {
                            boxes[i].textContent = letter;
                            boxes[i].style.color = '#dc3545';
                        });
                        
                        applyPenalty();
                        showFeedback('ahorcado-feedback', `‚ùå ¬°El globo explot√≥! La palabra era "${window.hangmanWord}". -5 minutos.`, false);
                        
                        // Dar otra oportunidad
                        setTimeout(() => {
                            createAhorcadoRoom();
                        }, 3000);
                    }, 500);
                }
            }
        }

        function updateWordDisplay() {
            const letters = window.hangmanWord.split('');
            const boxes = document.querySelectorAll('.letter-box');
            
            letters.forEach((letter, i) => {
                if (window.hangmanGuessed.includes(letter)) {
                    boxes[i].textContent = letter;
                }
            });
        }

        // ==================== SALA 6: BALANZA (NUEVA) ====================
        function createBalanzaRoom() {
            const puzzles = balancePuzzles[gameState.level];
            const puzzle = puzzles[Math.floor(Math.random() * puzzles.length)];
            
            window.balanzaPuzzle = puzzle;
            window.balanzaSelected = null;
            
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">‚öñÔ∏è La Sala de la Balanza</h2>
                    <p class="room-subtitle">Descubre el valor de cada objeto</p>
                    
                    <div class="puzzle-container">
                        <div class="balance-puzzle">
                            ${puzzle.equations.map(eq => `
                                <div class="balance-equation">
                                    <span class="balance-item">${eq.left}</span>
                                    <span>=</span>
                                    <span class="balance-item">${eq.right}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="balance-question">${puzzle.question}</div>
                        
                        <div class="balance-options">
                            ${puzzle.options.map(opt => `
                                <div class="balance-option" data-value="${opt}" onclick="selectBalanza(${opt})">${opt}</div>
                            `).join('')}
                        </div>

                        <div id="balanza-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(5)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkBalanza()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        function selectBalanza(value) {
            document.querySelectorAll('.balance-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.balance-option[data-value="${value}"]`).classList.add('selected');
            window.balanzaSelected = value;
        }

        function checkBalanza() {
            if (window.balanzaSelected === null) {
                showFeedback('balanza-feedback', 'Selecciona una respuesta primero', false);
                return;
            }

            const options = document.querySelectorAll('.balance-option');
            
            if (window.balanzaSelected === window.balanzaPuzzle.answer) {
                options.forEach(opt => {
                    if (parseInt(opt.dataset.value) === window.balanzaPuzzle.answer) {
                        opt.classList.add('correct');
                    }
                });
                showFeedback('balanza-feedback', '¬°Correcto! Has resuelto la ecuaci√≥n.', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Excelente razonamiento l√≥gico!");
                }, 1000);
            } else {
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    if (parseInt(opt.dataset.value) === window.balanzaSelected) {
                        opt.classList.add('incorrect');
                    }
                });
                applyPenalty();
                showFeedback('balanza-feedback', '‚ùå Esa no es la respuesta correcta. -5 minutos. Revisa las ecuaciones.', false);
                window.balanzaSelected = null;
            }
        }

        // ==================== SALA 7: CIENCIAS ====================
        function createCienciasRoom() {
            const content = levelContent[gameState.level].ciencias;
            const container = document.getElementById('room-container');
            
            window.scienceAnswers = {};
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üî¨ El Laboratorio de Ciencias</h2>
                    <p class="room-subtitle">Responde las preguntas cient√≠ficas (puede haber varias respuestas correctas)</p>
                    
                    <div class="puzzle-container">
                        ${content.map((q, qIndex) => `
                            <div class="science-question" id="science-q${qIndex}">
                                <h3>${q.question}</h3>
                                <div class="science-options">
                                    ${q.answers.map((answer, aIndex) => `
                                        <div class="science-card" data-qindex="${qIndex}" data-aindex="${aIndex}"
                                             onclick="toggleScienceAnswer(${qIndex}, ${aIndex})">
                                            ${answer}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}

                        <div id="ciencias-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(6)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkCiencias()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        function toggleScienceAnswer(qIndex, aIndex) {
            if (!window.scienceAnswers[qIndex]) {
                window.scienceAnswers[qIndex] = [];
            }
            
            const card = document.querySelector(`#science-q${qIndex} .science-card[data-aindex="${aIndex}"]`);
            const idx = window.scienceAnswers[qIndex].indexOf(aIndex);
            
            if (idx > -1) {
                window.scienceAnswers[qIndex].splice(idx, 1);
                card.classList.remove('selected');
            } else {
                window.scienceAnswers[qIndex].push(aIndex);
                card.classList.add('selected');
            }
        }

        function checkCiencias() {
            const content = levelContent[gameState.level].ciencias;
            let allCorrect = true;

            content.forEach((q, qIndex) => {
                const userAnswers = window.scienceAnswers[qIndex] || [];
                const correctAnswers = q.correct;

                const userSorted = [...userAnswers].sort((a, b) => a - b);
                const correctSorted = [...correctAnswers].sort((a, b) => a - b);
                
                const isCorrect = userSorted.length === correctSorted.length &&
                                userSorted.every((val, idx) => val === correctSorted[idx]);

                const cards = document.querySelectorAll(`#science-q${qIndex} .science-card`);
                cards.forEach((card, aIndex) => {
                    card.classList.remove('correct', 'incorrect', 'selected');
                    if (correctAnswers.includes(aIndex)) {
                        card.classList.add('correct');
                    } else if (userAnswers.includes(aIndex)) {
                        card.classList.add('incorrect');
                    }
                });

                if (!isCorrect) allCorrect = false;
            });

            if (allCorrect) {
                showFeedback('ciencias-feedback', '¬°Todas las respuestas son correctas!', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Impresionante conocimiento cient√≠fico!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('ciencias-feedback', '‚ùå Algunas respuestas no son correctas. -5 minutos.', false);
            }
        }

        // ==================== SALA 8: CANDADOS ====================
        function createCandadosRoom() {
            const puzzle = padlockPuzzles[gameState.level];
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üîê La Sala de los Candados</h2>
                    <p class="room-subtitle">Descifra el c√≥digo secreto usando las pistas</p>
                    
                    <div class="puzzle-container">
                        <div class="padlock-container">
                            <div class="padlock">
                                <div class="padlock-number">${puzzle.clue1.number}</div>
                                <div class="padlock-hint">üîç ${puzzle.clue1.hint}</div>
                            </div>
                            <div class="padlock">
                                <div class="padlock-number">${puzzle.clue2.number}</div>
                                <div class="padlock-hint">üîç ${puzzle.clue2.hint}</div>
                            </div>
                            <div class="padlock">
                                <div class="padlock-number">${puzzle.clue3.number}</div>
                                <div class="padlock-hint">üîç ${puzzle.clue3.hint}</div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 40px;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">
                                üîì Introduce el c√≥digo de 3 d√≠gitos:
                            </h3>
                            <div style="display: flex; justify-content: center; gap: 10px;">
                                <input type="text" class="padlock-input" id="padlock-0" maxlength="1" 
                                       onkeyup="movePadlockFocus(0)" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <input type="text" class="padlock-input" id="padlock-1" maxlength="1" 
                                       onkeyup="movePadlockFocus(1)" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                <input type="text" class="padlock-input" id="padlock-2" maxlength="1" 
                                       onkeyup="movePadlockFocus(2)" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                        </div>

                        <div id="candados-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(7)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkCandados()">üîì Abrir Candado</button>
                    </div>
                </div>
            `;
        }

        function movePadlockFocus(current) {
            const input = document.getElementById(`padlock-${current}`);
            if (input.value.length === 1 && current < 2) {
                document.getElementById(`padlock-${current + 1}`).focus();
            }
        }

        function checkCandados() {
            const puzzle = padlockPuzzles[gameState.level];
            let enteredCode = '';
            
            for (let i = 0; i < 3; i++) {
                const val = document.getElementById(`padlock-${i}`).value;
                if (val === '') {
                    showFeedback('candados-feedback', 'Completa los 3 d√≠gitos', false);
                    return;
                }
                enteredCode += val;
            }

            if (enteredCode === puzzle.answer) {
                showFeedback('candados-feedback', '¬°El candado se abre!', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Excelente l√≥gica deductiva!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('candados-feedback', '‚ùå C√≥digo incorrecto. -5 minutos.', false);
                for (let i = 0; i < 3; i++) {
                    document.getElementById(`padlock-${i}`).value = '';
                }
                document.getElementById('padlock-0').focus();
            }
        }

        // ==================== SALA 9: FAMILIA ====================
        function createFamiliaRoom() {
            const container = document.getElementById('room-container');
            
            const levelQuestions = familyQuestionsPool.filter(q => q.level === gameState.level);
            const shuffled = levelQuestions.sort(() => Math.random() - 0.5);
            const selectedQuestions = shuffled.slice(0, 3);
            
            window.familyQuestions = selectedQuestions;
            window.familyAnswers = {};
            
            container.innerHTML = `
                <div class="room">
                    <h2 class="room-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ La Sala de la Familia</h2>
                    <p class="room-subtitle">Resuelve estos acertijos de parentesco</p>
                    
                    <div class="puzzle-container">
                        ${selectedQuestions.map((q, qIndex) => `
                            <div class="family-question-card" id="family-q${qIndex}">
                                <div class="family-question">${q.question}</div>
                                <div class="family-options">
                                    ${q.options.map((opt, oIndex) => `
                                        <div class="family-option" data-qindex="${qIndex}" data-oindex="${oIndex}"
                                             onclick="selectFamilyAnswer(${qIndex}, ${oIndex})">
                                            ${opt}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}

                        <div id="familia-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(8)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkFamilia()">‚úì Comprobar</button>
                    </div>
                </div>
            `;
        }

        function selectFamilyAnswer(qIndex, oIndex) {
            document.querySelectorAll(`#family-q${qIndex} .family-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            const option = document.querySelector(`#family-q${qIndex} .family-option[data-oindex="${oIndex}"]`);
            option.classList.add('selected');
            
            window.familyAnswers[qIndex] = oIndex;
        }

        function checkFamilia() {
            if (Object.keys(window.familyAnswers).length !== 3) {
                showFeedback('familia-feedback', 'Responde las 3 preguntas', false);
                return;
            }

            let allCorrect = true;
            
            window.familyQuestions.forEach((q, qIndex) => {
                const userAnswer = window.familyAnswers[qIndex];
                const options = document.querySelectorAll(`#family-q${qIndex} .family-option`);
                
                options.forEach((opt, oIndex) => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                    if (oIndex === q.correct) {
                        opt.classList.add('correct');
                    } else if (oIndex === userAnswer && userAnswer !== q.correct) {
                        opt.classList.add('incorrect');
                    }
                });
                
                if (userAnswer !== q.correct) {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                showFeedback('familia-feedback', '¬°Todas las respuestas son correctas!', true);
                setTimeout(() => {
                    const code = Math.floor(Math.random() * 9) + 1;
                    gameState.codes.push(code);
                    completeRoom(code, "¬°Excelente conocimiento familiar!");
                }, 1000);
            } else {
                applyPenalty();
                showFeedback('familia-feedback', '‚ùå Algunas respuestas son incorrectas. -5 minutos.', false);
            }
        }

        // ==================== SALA 10: TESORO ====================
        function createTesoroRoom() {
            const container = document.getElementById('room-container');
            
            container.innerHTML = `
                <div class="room treasure-room">
                    <h2 class="room-title">üíé La Sala del Tesoro</h2>
                    <p class="room-subtitle">Introduce el c√≥digo de ${gameState.codes.length} cifras</p>
                    
                    <div class="puzzle-container">
                        <div class="treasure-chest">üéÅ</div>

                        <p style="text-align: center; font-size: 1.3em; margin: 30px 0;">
                            Recuerda los n√∫meros que obtuviste en cada sala:
                        </p>

                        <div class="code-input-container">
                            ${gameState.codes.map((_, i) => `
                                <input type="number" class="code-digit" id="digit-${i}" min="0" max="9" 
                                       onkeyup="moveToNext(${i})" maxlength="1">
                            `).join('')}
                        </div>

                        <div id="tesoro-feedback"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-hint" onclick="showHint(9)">üí° Pedir Pista</button>
                        <button class="btn btn-success" onclick="checkTreasureCode()">
                            üîì Abrir Cofre
                        </button>
                    </div>
                </div>
            `;
        }

        function moveToNext(current) {
            const input = document.getElementById(`digit-${current}`);
            if (input.value.length === 1 && current < gameState.codes.length - 1) {
                document.getElementById(`digit-${current + 1}`).focus();
            }
        }

        function checkTreasureCode() {
            const enteredCode = [];
            for (let i = 0; i < gameState.codes.length; i++) {
                const value = document.getElementById(`digit-${i}`).value;
                if (value === '') {
                    showFeedback('tesoro-feedback', `Completa los ${gameState.codes.length} d√≠gitos`, false);
                    return;
                }
                enteredCode.push(parseInt(value));
            }

            let correct = true;
            for (let i = 0; i < gameState.codes.length; i++) {
                if (enteredCode[i] !== gameState.codes[i]) {
                    correct = false;
                    break;
                }
            }

            if (correct) {
                showSuccessAnimation('üéâ');
                setTimeout(() => {
                    finishGame();
                }, 2000);
            } else {
                applyPenalty();
                showFeedback('tesoro-feedback', '‚ùå C√≥digo incorrecto. -5 minutos.', false);
            }
        }

        // ==================== FUNCIONES DE UTILIDAD ====================
        function showFeedback(elementId, message, isCorrect) {
            const feedback = document.getElementById(elementId);
            feedback.innerHTML = `<div class="feedback ${isCorrect ? 'correct' : 'incorrect'}">${message}</div>`;
            setTimeout(() => {
                feedback.innerHTML = '';
            }, 4000);
        }

        function completeRoom(code, message) {
            gameState.roomsCompleted++;
            updateProgress();

            document.getElementById('success-text').textContent = message;
            document.getElementById('code-found').textContent = code;
            document.getElementById('success-modal').classList.add('show');

            showSuccessAnimation('‚≠ê');
        }

        function showSuccessAnimation(emoji) {
            const animation = document.createElement('div');
            animation.className = 'success-animation';
            animation.textContent = emoji;
            document.body.appendChild(animation);
            setTimeout(() => animation.remove(), 1000);
        }

        function nextRoom() {
            document.getElementById('success-modal').classList.remove('show');
            if (gameState.currentRoom < gameState.totalRooms - 1) {
                loadRoom(gameState.currentRoom + 1);
            }
        }

        function showHint(roomIndex) {
            if (gameState.hintsLeft <= 0) {
                alert('No te quedan m√°s pistas');
                return;
            }

            gameState.hintsLeft--;
            gameState.timeRemaining -= 120;
            document.getElementById('hints-left').textContent = gameState.hintsLeft;

            const hintText = hints[gameState.level - 1][roomIndex];
            document.getElementById('hint-text').textContent = hintText;
            document.getElementById('hint-modal').classList.add('show');
        }

        function showCapitulinHelp() {
            const messages = [
                "¬°Hola! Soy Capitul√≠n. ¬øNecesitas ayuda? Usa el bot√≥n de pistas en cada sala.",
                "¬°√Ånimo! Est√°s haciendo un gran trabajo. Lee bien cada pregunta.",
                "No te rindas. Si algo es dif√≠cil, t√≥mate tu tiempo.",
                "¬°Vas muy bien! Cada sala te acerca m√°s al tesoro.",
                "¬°Cuidado con fallar! Cada error te quita 5 minutos.",
                "En el ahorcado, empieza por las vocales: A, E, I, O, U.",
                "En la balanza, sustituye los valores que ya conoces.",
                "En la memoria, intenta recordar las posiciones."
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('hint-text').textContent = randomMessage;
            document.getElementById('hint-modal').classList.add('show');
        }

        function closeHintModal() {
            document.getElementById('hint-modal').classList.remove('show');
        }

        function finishGame() {
            clearInterval(gameState.timerInterval);
            
            const timeUsed = 3600 - gameState.timeRemaining;
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            
            document.getElementById('explorer-name').textContent = 
                prompt('¬°Felicidades! Introduce tu nombre:') || 'Explorador Valiente';
            document.getElementById('final-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('final-hints').textContent = 3 - gameState.hintsLeft;
            
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
        }

        function gameOver() {
            clearInterval(gameState.timerInterval);
            alert('¬°Se acab√≥ el tiempo! Puedes intentarlo de nuevo.');
            location.reload();
        }

        // Eventos de drag & drop
        document.addEventListener('dragover', (e) => {
            if (!e.target.classList.contains('drop-zone')) {
                e.preventDefault();
            }
        });

        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('drag-over');
            }
        });
    </script>
</body>
</html>